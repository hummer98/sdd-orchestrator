# Response to Document Review #2

**Feature**: document-review-auto-loop
**Review Date**: 2026-01-12
**Reply Date**: 2026-01-12

---

## Response Summary

| Severity | Issues | Fix Required | No Fix Needed | Needs Discussion |
| -------- | ------ | ------------ | ------------- | ---------------- |
| Critical | 0      | 0            | 0             | 0                |
| Warning  | 1      | 1            | 0             | 0                |
| Info     | 1      | 0            | 1             | 0                |

---

## Response to Warnings

### W6: Fix Required / Needs Discussion カウントの取得方法不明確

**Issue**: Design と Tasks で Fix Required / Needs Discussion カウントの取得元が「roundDetails」か「document-review-reply が書き込むカウント情報」か明確でない。Design の Data Models セクションでは `roundDetails` には `fixApplied` のみ定義されており、カウント情報のスキーマが未定義。

**Judgment**: **Fix Required** ✅

**Evidence**:

既存コードを確認した結果:

1. **既存の `RoundDetail` インターフェース** (`electron-sdd-manager/src/shared/types/review.ts:46-57`):
```typescript
export interface RoundDetail {
  roundNumber: number;
  reviewCompletedAt?: string;
  replyCompletedAt?: string;
  status: RoundStatus;
  fixApplied?: boolean;
}
```
現状では `fixRequiredCount` / `needsDiscussionCount` フィールドは存在しない。

2. **既存の handlers.ts ロジック** (`line 1988-1990`):
```typescript
// SSOT: The prompt sets documentReview.status = 'approved' when fixRequiredCount === 0
const specJsonResult = await docReviewService.readSpecJson(specPath);
const isApproved = specJsonResult.ok && specJsonResult.value.documentReview?.status === 'approved';
```
現状では `documentReview.status` のみを判定しており、カウント情報は参照していない。

3. **document-review-reply.md コマンド仕様** (line 202-204):
```markdown
3. **If Fix Required total is 0** (all issues resolved):
   - Set `documentReview.status = "approved"` in spec.json
```
コマンドは `status` のみを設定し、カウント情報は書き込んでいない。

**問題の確認**:
レビュー指摘通り、Design で定義した「Fix Required > 0 で次ラウンド継続」「Needs Discussion > 0 で paused」のロジックを実装するには、カウント情報をどこから取得するかを明確にする必要がある。

**Action Items**:

1. **design.md の RoundDetail スキーマを拡張** - `fixRequiredCount` と `needsDiscussionCount` フィールドを追加
2. **design.md の document-review-reply.md セクションに書き込み仕様を追記** - reply 完了時に `roundDetails` にカウント情報を保存する仕様を明記

---

## Response to Info (Low Priority)

| #   | Issue | Judgment | Reason |
| --- | ----- | -------- | ------ |
| I3  | roundDetails スキーマ拡張 | No Fix Needed ❌ | W6 の対応として design.md を修正すれば自動的に解決される |

---

## Files to Modify

| File | Changes |
| ---- | ------- |
| `.kiro/specs/document-review-auto-loop/design.md` | RoundDetail インターフェースに `fixRequiredCount?: number` と `needsDiscussionCount?: number` を追加。document-review-reply.md セクションに roundDetails へのカウント書き込み仕様を追記 |

---

## Conclusion

Review #2 では、前回指摘された Critical 3件、Warning 4件がすべて解決されていることが確認された。

今回新規で指摘された W6（Fix Required / Needs Discussion カウントの取得方法不明確）は妥当な指摘であり、design.md の修正が必要。この修正により、handlers.ts 実装時にカウント情報の取得方法が明確になる。

**次のステップ**: `--fix` を実行して design.md を修正後、次の document-review ラウンドを実行するか、実装フェーズに進む。

---

## Applied Fixes

**Applied Date**: 2026-01-12
**Applied By**: --fix

### Summary

| File | Changes Applied |
| ---- | --------------- |
| `.kiro/specs/document-review-auto-loop/design.md` | RoundDetail インターフェースにカウントフィールドを追加、document-review-reply.md セクションにカウント書き込み仕様を追記 |

### Details

#### `.kiro/specs/document-review-auto-loop/design.md`

**Issue(s) Addressed**: W6

**Changes**:
- `RoundDetail` インターフェースに `fixRequiredCount?: number` と `needsDiscussionCount?: number` フィールドを追加
- document-review-reply.md セクションに roundDetails へのカウント書き込み仕様を追記

**Diff Summary**:
```diff
 interface RoundDetail {
   roundNumber: number;
   reviewCompletedAt?: string;
   replyCompletedAt?: string;
   status: RoundStatus;
   fixApplied?: boolean;
+  /** Fix Required と判定された issue の数 */
+  fixRequiredCount?: number;
+  /** Needs Discussion と判定された issue の数 */
+  needsDiscussionCount?: number;
 }
```

```diff
 **Dependencies**
 - Outbound: spec.json - documentReview フィールド更新 (P0)

+**roundDetails へのカウント書き込み仕様**:
+
+Reply 完了時、`roundDetails[n-1]` に以下のフィールドを書き込む:
+```json
+{
+  "roundNumber": n,
+  "status": "reply_complete",
+  "fixRequiredCount": <Response Summary の Fix Required 合計>,
+  "needsDiscussionCount": <Response Summary の Needs Discussion 合計>
+}
+```
+
+handlers.ts はこの `fixRequiredCount` と `needsDiscussionCount` を参照してループ継続/終了を判定する。
+
 **Needs Discussion 判定ガイドライン**:
```

---

_Fixes applied by document-review-reply command._

---

_This reply was generated by the document-review-reply command._
