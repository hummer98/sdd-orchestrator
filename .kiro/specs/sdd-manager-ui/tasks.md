# Implementation Plan

## 1. プロジェクト基盤とTauriアプリケーション構成

- [x] 1.1 Tauriプロジェクト初期化とビルド環境構築
  - Tauri 2.x + Vite + React 18 + TypeScript 5の初期プロジェクトを作成
  - 必要なTauriプラグイン（shell, fs）の依存関係を設定
  - tauri-specta + spectaによる型生成パイプラインを構成
  - 開発用ビルドスクリプトとホットリロード設定
  - _Requirements: 10.1, 12.1_

- [x] 1.2 (P) Rustバックエンドの基本構造とエラー型定義
  - AppError enum を全エラーケース（FileNotFound, SpecNotFound, PhaseNotReady等）で定義
  - Result型とシリアライゼーション設定
  - tracingクレートによるログ出力基盤
  - _Requirements: 11.5, 12.1_

- [x] 1.3 (P) フロントエンド基本構造とプロバイダー設定
  - React Query ClientとZustandストアの初期化
  - テーマ設定（OSダークモード検出と適用）
  - グローバルエラーバウンダリの実装
  - Tailwind CSS + shadcn/ui のセットアップ
  - _Requirements: 10.5, 10.6, 11.1, 11.2_

- [x] 1.4 型安全IPC基盤の構築
  - tauri-spectaによるRustコマンドのTypeScript型自動生成
  - フロントエンドからのコマンド呼び出しラッパー
  - イベント型定義（LogStreamEvent, FileChangedEvent等）
  - 非同期IPC呼び出しのユーティリティ関数
  - _Requirements: 12.1, 12.5, 12.6_

## 2. 状態管理ストア群の実装

- [x] 2.1 (P) 設定管理ストア（ConfigStore）の実装
  - 現在のプロジェクトパス、最近のプロジェクト履歴、テーマ設定の状態管理
  - ローカルストレージへの永続化と読み込み
  - アプリ起動時の最後に開いたプロジェクト復元
  - _Requirements: 7.4, 7.5_

- [x] 2.2 (P) 通知管理ストア（NotificationStore）の実装
  - 通知キュー（success, error, warning, info）の管理
  - 自動消去タイマー処理
  - 通知の追加・削除・クリア操作
  - _Requirements: 11.1, 11.2_

- [x] 2.3 (P) ログ管理ストア（LogStore）の実装
  - 実行ログエントリの蓄積（最大10000行）
  - ストリーミング状態と完了状態の管理
  - 仕様名・フェーズ別のログ分離
  - _Requirements: 6.1, 6.3_

- [x] 2.4 (P) エディタ状態ストア（EditorStore）の実装
  - 未保存変更の追跡（isDirty判定）
  - 編集モード/プレビューモードの状態管理
  - 複数ファイルの編集状態を同時管理
  - _Requirements: 9.4, 9.5_

## 3. Rustバックエンド IPC コマンド実装

- [x] 3.1 プロジェクト選択と検証コマンドの実装
  - select_project：ディレクトリ選択ダイアログを表示し、.kiroディレクトリの存在を検証
  - get_recent_projects：永続化された履歴からプロジェクト一覧を返却
  - プロジェクトパスのバリデーションとsteering ファイル存在チェック
  - _Requirements: 7.1, 7.2, 7.3, 7.6_

- [x] 3.2 仕様一覧取得コマンドの実装
  - list_specs：.kiro/specs/ディレクトリをスキャンして全仕様のサマリーを返却
  - 各仕様のphase, status, updated_atを集約
  - ソート済み結果の返却
  - _Requirements: 1.1, 1.2, 1.4_

- [x] 3.3 仕様詳細・成果物取得コマンドの実装
  - get_spec_detail：spec.jsonを読み取りメタデータと成果物情報を返却
  - get_artifact_content：requirements.md, design.md, tasks.mdの内容を取得
  - 成果物が存在しない場合のハンドリング
  - _Requirements: 2.1, 2.2, 2.3, 2.5, 2.6_

- [x] 3.4 仕様作成コマンドの実装
  - create_spec：.kiro/specs/{feature_name}/ディレクトリとspec.jsonを生成
  - 重複仕様名のチェックとエラー返却
  - 初期メタデータ（phase: initialized, approvals全てfalse）の設定
  - _Requirements: 3.3, 3.4, 3.5_

- [x] 3.5 フェーズ実行コマンドの実装
  - execute_phase：Claude Code CLIを子プロセスとして生成
  - 標準出力/標準エラー出力をリアルタイムでイベント発行
  - 前提フェーズの承認状態を検証し、未承認なら実行拒否
  - 実行完了時に終了コードと実行時間を返却
  - _Requirements: 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 12.3_

- [x] 3.6 承認・却下コマンドの実装
  - approve_phase：spec.jsonの該当フェーズapprovalをtrueに更新
  - reject_phase：却下理由を記録（オプション：履歴として保存）
  - ready_for_implementationフラグの自動更新
  - _Requirements: 5.2, 5.3, 5.5_

- [x] 3.7 成果物保存コマンドの実装
  - save_artifact：指定された成果物ファイルに内容を書き込み
  - 保存日時の返却
  - ファイル書き込み権限エラーのハンドリング
  - _Requirements: 9.3, 11.3_

- [x] 3.8 ファイル監視コマンドとイベントの実装
  - start_watching：.kiro/specs/ディレクトリの監視を開始（notifyクレート使用）
  - stop_watching：監視の停止
  - FileChangedEventの発行（パスと変更種別）
  - デバウンス設定（300ms）で重複イベントを抑制
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

## 4. UI コンポーネント実装 - 仕様管理

- [x] 4.1 仕様一覧パネルの実装
  - TanStack Queryで仕様一覧を取得・キャッシュ
  - 名前、更新日時、ステータスによるソート機能
  - ステータス別アイコン・色による視覚的区別
  - 仕様選択時の詳細ビューへの遷移
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.6_

- [x] 4.2 仕様詳細パネルの実装
  - 選択された仕様のメタデータ表示
  - 各フェーズの承認状態をバッジ/アイコンで可視化
  - 作成日時・更新日時の表示
  - _Requirements: 2.1, 2.2, 2.5_

- [x] 4.3 成果物タブコンポーネントの実装
  - requirements.md, design.md, tasks.mdのタブ切り替え
  - 各成果物のMarkdownレンダリング表示
  - 未生成の場合のプレースホルダー表示
  - _Requirements: 2.3, 2.4, 2.6_

- [x] 4.4 仕様作成ダイアログの実装
  - フォーム入力（仕様名、説明）とバリデーション
  - 重複エラー時のメッセージ表示
  - 作成成功時の一覧自動更新（キャッシュ無効化）
  - _Requirements: 3.1, 3.2, 3.5, 3.6_

## 5. UI コンポーネント実装 - ワークフロー制御

- [x] 5.1 フェーズ実行制御パネルの実装
  - 各フェーズ（requirements, design, tasks, implementation）の実行ボタン
  - 前提フェーズ未承認時のボタン無効化
  - 実行中の進行状況インジケーター表示
  - auto-approveオプションの切り替え
  - _Requirements: 4.1, 4.6, 4.7_

- [x] 5.2 承認パネルの実装
  - 「承認」「却下」ボタンの表示
  - 却下理由入力ダイアログ
  - 成果物未生成時のボタン無効化
  - 承認状態変更時のUI自動更新
  - _Requirements: 5.1, 5.3, 5.6_

- [x] 5.3 ログパネルの実装
  - IPCイベントを購読してリアルタイムログ表示
  - 自動スクロール機能
  - エラーログ（stderr）の赤色ハイライト
  - 終了コードと実行時間の表示
  - クリップボードへのコピー機能
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

## 6. UI コンポーネント実装 - 設定とエディタ

- [x] 6.1 プロジェクト設定パネルの実装
  - プロジェクト選択ボタンとディレクトリ選択連携
  - 最近のプロジェクト履歴の表示と選択
  - .kiroディレクトリ不在時の初期化オプション提示
  - steeringファイル存在状況の表示
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.6_

- [x] 6.2 Markdownエディタコンポーネントの実装
  - @uiw/react-md-editorによる編集UI
  - 編集モード/プレビューモードの切り替え
  - Markdownツールバー（見出し、リスト、コード等）
  - 保存ボタンと保存処理
  - _Requirements: 9.1, 9.2, 9.3, 9.6_

- [x] 6.3 未保存変更管理の実装
  - エディタタブに未保存インジケーター表示
  - 閉じる前の保存確認ダイアログ
  - EditorStoreとの状態同期
  - _Requirements: 9.4, 9.5_

## 7. UI コンポーネント実装 - フィードバックとエラー処理

- [x] 7.1 通知プロバイダーとトースト表示の実装
  - 成功・エラー・警告・情報の各種トースト
  - 自動消去とアクションボタン
  - エラー詳細ダイアログへの遷移
  - _Requirements: 11.1, 11.2_

- [x] 7.2 エラーダイアログと推奨手順表示の実装
  - 操作失敗時のエラー詳細表示
  - 権限エラー、ネットワークエラー等の分類
  - 回復可能エラーの推奨解決手順
  - リトライオプションの提供
  - _Requirements: 11.2, 11.3, 11.4, 11.6_

## 8. ファイル監視とリアルタイム更新の統合

- [x] 8.1 ファイル監視イベントの購読と処理
  - FileChangedEventリスナーの登録
  - 変更種別（作成・更新・削除）に応じた処理分岐
  - TanStack Queryキャッシュの選択的無効化
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 8.2 自動更新時の通知表示
  - ファイル変更検出時のトースト通知
  - 更新内容の簡潔な説明
  - _Requirements: 8.6_

- [x] 8.3 仕様一覧の自動更新連携
  - 新規仕様追加時のリスト更新
  - 仕様削除時のリスト更新
  - 選択中の仕様が削除された場合のハンドリング
  - _Requirements: 1.5, 8.4, 8.5_

## 9. クロスプラットフォーム対応と最適化

- [x] 9.1 プラットフォーム別設定の実装
  - ネイティブウィンドウ装飾の設定
  - プラットフォーム標準キーボードショートカット（Cmd/Ctrl対応）
  - ファイルパス形式の正規化
  - _Requirements: 10.2, 10.3, 10.4_

- [x] 9.2 Tauri セキュリティ設定の構成
  - Content Security Policy (CSP) の設定
  - Shell pluginスコープ（claude CLIのみ許可）
  - File system pluginスコープ（プロジェクトディレクトリ限定）
  - _Requirements: 12.6_

- [x] 9.3 パフォーマンス最適化の実装
  - 大量仕様・ログ表示用の仮想スクロール
  - ファイル監視イベントのデバウンス
  - クエリキャッシュのstaleTime/gcTime設定
  - _Requirements: 10.1_

## 10. IPC通信エラーハンドリングとタイムアウト処理

- [x] 10.1 IPCタイムアウトとリトライ機構の実装
  - 長時間実行コマンドのタイムアウト設定
  - タイムアウトエラーの適切なユーザー通知
  - リトライオプションの提供
  - _Requirements: 12.4, 11.4_

- [x] 10.2 外部サービスエラーのハンドリング
  - Claude Code CLI未検出エラーの対応
  - インストール手順へのガイダンス表示
  - CLI実行エラー時のログパネル強調
  - _Requirements: 11.6_

## 11. 統合テストとE2Eテスト

- [x] 11.1 IPC通信の統合テスト
  - 全コマンドの呼び出し→処理→結果返却の検証
  - エラーケース（存在しない仕様、権限エラー等）のテスト
  - イベントストリーミングの検証
  - _Requirements: 12.1, 12.2, 12.3, 12.4, 12.5_

- [x] 11.2 ワークフローE2Eテスト
  - 仕様作成→各フェーズ実行→承認の一連フロー
  - エディタでの編集→保存→プレビュー確認
  - プロジェクト切り替えと履歴復元
  - _Requirements: 3.1-3.6, 4.1-4.7, 5.1-5.6, 9.1-9.6_

- [x] 11.3 受け入れ条件ベースのテストカバレッジ
  - 各要件の受け入れ条件に対する網羅的テスト
  - エッジケース（空の仕様一覧、大量ログ等）のテスト
  - クロスプラットフォーム動作確認
  - _Requirements: 1.1-1.6, 2.1-2.6, 6.1-6.6, 7.1-7.6, 8.1-8.6, 10.1-10.6, 11.1-11.6_

