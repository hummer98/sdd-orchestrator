# SDDワークフローにおけるプロンプト改善案

**日付:** 2026-01-22
**作成者:** Gemini CLI Agent
**状況:** 適用済み (2026-01-22)
**関連インシデント:** `agent-store-unification` のリファクタリング失敗、および `project-selection-view` の成功事例の比較

## 1. エグゼクティブサマリー

直近の `.kiro/specs/` の成果物分析により、AIエージェントがリファクタリングや統合タスクを実行する際の致命的な弱点が判明しました。
- **問題点:** エージェントに「温存バイアス（既存コードの変更や削除を避け、新規ファイル作成を優先する）」と「字面通りの解釈バイアス（表面的なチェックでタスク完了と見なす）」が存在します。
- **症状:** 「見せかけのリファクタリング（未使用のFacade作成）」、「ゾンビコード（古いロジックが残存）」、「結合漏れ（新機能がアプリに繋がっていない）」が発生しています。
- **解決策:** SDDの各フェーズ（設計、タスク生成、レビュー、検査）のプロンプトに、「破壊的変更（削除）」と「配線（結合）」の明示的な指示を組み込みます。

## 2. 根本原因の分析

| バイアス / 問題 | 内容 | 証拠 |
| :--- | :--- | :--- |
| **温存バイアス (Preservation Bias)** | 既存コードの削除や大幅変更を「リスク」と見なし、安全策として並列ファイル（例: `agentStoreFacade.ts`）を新規作成して要件を満たそうとする。 | `agent-store-unification`: 新規ファイルを作ったが、既存の `renderer/agentStore.ts` を放置した。 |
| **字面通りの解釈 (Literal Interpretation)** | 「互換性の確保」を「インポート文を変えないこと」と解釈し、古いファイルを指したままでも「文面通りなら合格」と判定してしまう。 | `agent-store-unification`: 21個のコンポーネントが古いストアを参照し続けていることを「互換性あり」と見なした。 |
| **暗黙の結合 (Implicit Integration)** | ワークフロー上「実装」に「結合」が含まれると勝手に仮定している。明示的なタスクがない場合、ロジックだけ作って「配線」を忘れる。 | `agent-store-unification`: 新しいFacadeがアプリケーションのどこからも使われていなかった。 |

## 3. プロンプト改善案

### 3.1 `spec-design.md` (設計フェーズ)

**現状の弱点:** アーキテクチャに集中し、クリーンアップや配線の戦略が義務付けられていない。

**改善案 (信頼度: 高):**
**「結合・廃止戦略 (Integration & Deprecation Strategy)」**セクションの出力を義務付けます。

```markdown
CRITICAL: 「結合・廃止戦略」セクションを必ず生成すること。
- 修正が必要な既存ファイル（配線箇所）を具体的にリストアップすること。
- 削除が必要な既存ファイル（クリーンアップ）を具体的にリストアップすること。
- リファクタリングの場合、「ファイルXをYで置き換える」のか「並列でファイルZを作るのか」を明記すること。
```

### 3.2 `spec-tasks.md` (タスク生成フェーズ)

**現状の弱点:** 「実装」タスクに偏り、結合やクリーンアップが副次的または暗黙的になっている。

**改善案 (信頼度: 高):**
タスクカテゴリの義務付けと、強い物理的動作を表す動詞の使用。

```markdown
**タスク生成時の必須カテゴリ**:
1. **実装タスク**: ロジックの作成。
2. **結合・配線 (Wiring) タスク**: `App.tsx` や `index.ts`、利用元コンポーネントを更新して新ロジックを使用させる。
   - 「[ファイルリスト] のインポートパスを更新する」等の具体的な指示を含めること。
3. **クリーンアップ・廃止タスク**: 古いファイルやロジックの削除。
   - 「削除 (DELETE)」、「除去 (REMOVE)」、「廃止」という強い言葉を使うこと。
   - 例: "- [ ] 4.1 `renderer/components/RecentProjects.tsx` を物理削除する"

**リファクタリング時の制約**:
- 段階的ロールアウトが明示的に設計されていない限り、並列実装（新旧共存）を禁止し、「既存ファイルの置き換え」をタスクにすること。
```

### 3.3 `document-review.md` (レビューフェーズ)

**現状の弱点:** 整合性はチェックするが、「リファクタリングの完遂（古いものが消えるか）」というヒューリスティックがない。

**改善案 (信頼度: 中〜高):**
`Acceptance Criteria → Tasks Coverage` に「リファクタリング整合性チェック」を追加。

```markdown
**リファクタリング整合性チェック (CRITICAL)**:
設計が置換や廃止を示唆している場合:
- 古いファイルを物理的に削除するタスクがあるか確認。
- 利用元のインポートを更新するタスクがあるか確認。
- 古い機能を残したまま新しいファイルを追加するだけの「見せかけのリファクタリング」を **CRITICAL** として報告。
```

### 3.4 `spec-inspection.md` (検査フェーズ)

**現状の弱点:** 「デッドコード」の検出が「新しく作ったコードが使われているか」に偏っており、消されるべきだった古いコード（ゾンビコード）を見逃している。

**改善案 (信頼度: 高):**
「デッドコード検出」と「タスク完了チェック」の強化。

```markdown
#### 2.6 デッドコード & ゾンビコード検出
- **新規コード**: 新しいコンポーネントが実際にインポートされ、使用されているか。
- **ゾンビコード**: リファクタリングの場合、古い実装が削除または無効化されているか。
  - `tasks.md` で削除予定だったファイルがまだ存在していないか。
  - 消費側のファイルに古いインポートが残っていないか。

#### 2.3 タスク完了チェックの強化
- 「削除」タスクに対し、ファイルが実際にファイルシステムから消えているか確認。
- 「配線」タスクに対し、利用元ファイルが実際に新コードを参照しているか確認。
```

## 4. 期待される効果

| 指標 | 現状 | 改善後 |
| :--- | :--- | :--- |
| **デッドコード蓄積** | 高（古いファイルが放置される） | 低（削除タスクの明示） |
| **統合の成功率** | 不安定（手動修正が必要なことが多い） | 高（配線タスクの明示） |
| **リファクタリング品質** | 表面的な並列実装 | 根本的なコード置換 |

## 5. ネクストステップ

1.  `.claude/commands/kiro/` 内のプロンプトファイルに上記改善案を適用する。
2.  小規模なリファクタリングタスクで、新しいワークフローをテストする。
3.  `tasks.md` 生成時に「配線」や「削除」のカテゴリが正しく出現するか監視する。
