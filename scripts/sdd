#!/bin/bash

# SDD Orchestrator CLI
# Usage: sdd [path]
#   sdd             - Open current directory
#   sdd .           - Open current directory
#   sdd /path/to   - Open specified path

set -e

# IMPORTANT: Unset ELECTRON_RUN_AS_NODE for Electron-based IDEs
unset ELECTRON_RUN_AS_NODE

# Find the installed app
APP_PATH="/Applications/SDD Orchestrator.app"

if [ ! -d "$APP_PATH" ]; then
    echo "Error: SDD Orchestrator.app not found in /Applications/"
    echo "Please install the app first."
    exit 1
fi

# 引数処理
TARGET_PATH=""
if [ -n "$1" ]; then
    # 相対パスを絶対パスに変換
    if [[ "$1" = /* ]]; then
        TARGET_PATH="$1"
    else
        TARGET_PATH="$(cd "$1" 2>/dev/null && pwd)" || {
            echo "Error: Directory '$1' does not exist"
            exit 1
        }
    fi
else
    # 引数が指定されていない場合はカレントディレクトリを使用
    TARGET_PATH="$(pwd)"
fi

# アプリを起動
# macOSのopenコマンドはパッケージ版Electronアプリに引数を正しく渡せない問題がある
# https://github.com/electron/electron/issues/7755
# 解決策: 直接実行ファイルを呼び出すか、環境変数を使用する
EXEC_PATH="$APP_PATH/Contents/MacOS/SDD Orchestrator"

if [ -x "$EXEC_PATH" ]; then
    # 直接実行ファイルを呼び出す（引数が正しく渡される）
    "$EXEC_PATH" --project="$TARGET_PATH" &
else
    # フォールバック: 環境変数経由で渡す
    SDD_PROJECT_PATH="$TARGET_PATH" open -a "$APP_PATH"
fi
