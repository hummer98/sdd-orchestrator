# 仕様検討記録

## 基本情報
- **作成日**: 2025-12-27
- **機能名**: parallel-task-impl

## 初期要求
現在の実装はspec-implにタスク番号を渡さずに一気に実装するリクエストになってると思いますが、もう一つ「並列実装」ボタンを設置し、上から順番にspec-impl(spec-manager場合はimpl)でバラバラのclaudeセッションで実装させるモードを追加したいです。
tasksにおける(P)マークは並列実装が可能なマークだと思うのですが、(P)マークが現れた場合は、並列に実装タスクを生成して、すべてが完了したら次のステップに進む、という進め方でいいのかなと思ってます

## 質疑応答

### Q1. 機能のスコープについて
**質問**:
- 1-1. 「並列実装ボタン」はどこに配置する想定ですか？（a: 既存「実装」ボタンの隣、b: TaskProgressView上部、c: 別の場所）
- 1-2. 並列実装はタスク単位での並列実行か、Spec単位か？

**回答**:
- 1-1: a（既存「実装」ボタンの隣）
- 1-2: タスク単位

### Q2. (P)マークの解釈について
**質問**:
- 2-1. (P)マークを「自動的に並列セッションで実行」として扱う理解で正しいか？
- 2-2. 実行フロー確認（1.1(P), 1.2(P) → 2.1 → 2.2(P), 2.3(P)）

**回答**:
- 2-1: はい
- 2-2: はい（理解通り）

### Q3. 技術的な制約について
**質問**:
- 3-1. MAX_CONCURRENT_SPECS=5の上限を適用するか？
- 3-2. spec-managerとkiro両方のコマンドセットに対応するか？

**回答**:
- 3-1: はい
- 3-2: はい（両方対応）

### Q4. エラーハンドリングについて
**質問**:
- 4-1. 並列実行中に1つのタスクが失敗した場合の動作は？（a: 全停止、b: 他続行・全体完了時エラー、c: 失敗記録・次グループ進まない）

**回答**:
- 4-1: c（失敗タスクを記録して次のグループに進まない）

### Q5. タスク解析について
**質問**:
- 5-1. 既存のimplCompletionAnalyzer.tsを拡張するか、新しいパーサーを作成するか？
- 5-2. 親タスクに(P)がなくサブタスクに(P)がある場合、サブタスク単位で並列実行するか？

**回答**:
- 5-1: 新規作成（責務が異なるため）
- 5-2: はい

### Q6. UI表示について
**質問**:
- 6-1. 並列実行中のタスク進捗表示はどのようなイメージか？（a: TaskProgressView拡張、b: AgentListPanel表示、c: 両方）

**回答**:
- 6-1: b（AgentListPanelで複数Agent表示、並列実行ボタン自体も実行中状態を表示）

### Q7. ボタンのラベル・動作について
**質問**:
- 7-1. 「並列実装」ボタン1回押しで全タスク完了まで自動進行するか？
- 7-2. 既存の「実装」ボタンはそのまま残すか？

**回答**:
- 7-1: はい（1回押しで全完了まで）
- 7-2: はい（現行動作を維持）

## 調査・検討結果
- 既存の`implCompletionAnalyzer.ts`はログ解析用でClaude APIを使用しており、tasks.mdパースとは責務が異なる
- `tasks-parallel-analysis.md`に(P)マークの付与ルールが定義済み
- `auto-execution-parallel-spec`で並列Spec実行の基盤が既に存在
- `TaskProgressView`は個別タスクの実行ボタンを持つが、並列実行機能はない

## 決定事項
- 新規パーサー`taskParallelParser.ts`を作成してtasks.mdを解析
- (P)マークに基づいてタスクをグループ化
- グループ内タスクは並列でClaudeセッション起動
- 失敗時は次グループに進まない
- MAX_CONCURRENT_SPECS=5の上限を適用
- `/kiro:spec-impl`と`/spec-manager:impl`両方に対応

## 備考
- 並列実行中のキャンセル機能も考慮が必要
- tasks.mdのネスト構造（親タスク・サブタスク）の解析ロジックが重要
