# Response to Document Review #1

**Feature**: agent-exit-robustness
**Review Date**: 2026-01-22
**Reply Date**: 2026-01-22

---

## Response Summary

| Severity | Issues | Fix Required | No Fix Needed | Needs Discussion |
| -------- | ------ | ------------ | ------------- | ---------------- |
| Critical | 0      | 0            | 0             | 0                |
| Warning  | 2      | 0            | 2             | 0                |
| Info     | 3      | 0            | 3             | 0                |

---

## Response to Warnings

### W-001: Remote UI対応の明記がない

**Issue**: Requirements.mdに「Remote UI対応: 要」を追記し、toast通知がRemote UIでも動作することを明記することを推奨。

**Judgment**: **No Fix Needed** ❌

**Evidence**:
既存のコードパターンを確認した結果、`onStatusChange`コールバック → handlers.ts → WebSocketHandler.broadcastAgentOutput/broadcastAgentStatus というパターンで、既にRemote UIへの通知が自動的に行われている。

handlers.ts (line 841-846):
```typescript
service.onStatusChange(async (agentId, status) => {
  logger.info('[handlers] Agent status change', { agentId, status });
  if (!window.isDestroyed()) {
    window.webContents.send(IPC_CHANNELS.AGENT_STATUS_CHANGE, agentId, status);
  }
  // ... WebSocketHandler経由でRemote UIにもブロードキャスト
```

`onAgentExitError`も同じパターンで実装すれば、handlers.tsでコールバック登録時にWebSocketHandler経由のブロードキャストを追加するだけでRemote UI対応が完了する。これはDesignの範囲内であり、Requirements/Designに明示的に追記する必要はない。実装時に既存パターンに従えば自動的に対応される。

**Action Items**: なし（既存パターンに従って実装すれば対応完了）

---

### W-002: offAgentExitErrorのユースケース不明

**Issue**: Design.mdでoffAgentExitErrorメソッドを定義しているが、handlers.tsでの登録解除が必要なケースが想定されていない。コールバック解除が不要なら、offAgentExitErrorの実装を省略することを検討。

**Judgment**: **No Fix Needed** ❌

**Evidence**:
既存のコードパターンを確認した結果、`offStatusChange`は実際に使用されている。

handlers.ts (line 2331-2332):
```typescript
coordinator.handleAgentCompleted(agentId, specPath, finalStatus as 'completed' | 'failed' | 'interrupted');
service.offStatusChange(handleStatusChange);
```

execute-next-phase、execute-document-review、execute-inspection、execute-spec-mergeなど複数の箇所で、特定のエージェント完了を待つ一時的なコールバックを登録し、完了後に`offStatusChange`で解除している。

`offAgentExitError`も同様のユースケースが想定される：
- 特定のエージェント終了エラーを監視し、処理完了後にコールバックを解除する
- 一貫したAPIデザイン（on/offペア）を維持する

設計の一貫性とAPIの対称性を保つため、`offAgentExitError`は維持すべき。

**Action Items**: なし

---

## Response to Info (Low Priority)

| #    | Issue     | Judgment      | Reason         |
| ---- | --------- | ------------- | -------------- |
| I-001 | WORKTREE_LIFECYCLE_PHASESに将来追加されるフェーズの候補が明記されていない | No Fix Needed | 将来の候補をコメントで列挙することは「予測不能な将来の要件」を文書化することであり、YAGNI原則に反する。現時点で必要なspec-mergeのみを定義し、将来の追加はその時点で行う方が適切。 |
| I-002 | stopAgent中にreadRecordとファイル書き込みの両方が失敗する稀なケースの扱い | No Fix Needed | DD-002で言及済み。この稀なケースのためにコードを複雑化する必要はない。現在の設計（code/isForcedSuccessベースのフォールバック）で十分にロバスト。 |
| I-003 | Remote UIでのtoast通知動作が明記されていない | No Fix Needed | W-001と同様。既存パターンに従えば自動的に対応される。 |

---

## Files to Modify

| File   | Changes   |
| ------ | --------- |
| なし | 修正不要 |

---

## Conclusion

全ての指摘事項を検証した結果、**修正が必要な項目はない**。

- **W-001 (Remote UI対応)**: 既存のコールバック→IPC→WebSocketHandlerパターンに従えば自動的に対応される
- **W-002 (offAgentExitError)**: 既存のoffStatusChangeと同様のユースケースがあり、API一貫性のため維持すべき
- **Info項目**: YAGNI原則に基づき、現時点で必要な仕様のみを定義

仕様書は実装に進むのに十分な品質である。

**Next Steps**:
- `/kiro:spec-impl agent-exit-robustness` で実装を開始可能

---

_This reply was generated by the document-review-reply command._
