# Response to Document Review #1

**Feature**: project-log-separation
**Review Date**: 2025-12-22
**Reply Date**: 2025-12-22

---

## Response Summary

| Severity | Issues | Fix Required | No Fix Needed | Needs Discussion |
| -------- | ------ | ------------ | ------------- | ---------------- |
| Critical | 1      | 1            | 0             | 0                |
| Warning  | 3      | 2            | 1             | 0                |
| Info     | 2      | 0            | 2             | 0                |

---

## Response to Critical Issues

### C1: currentProjectPathの二重管理

**Issue**: `handlers.ts` に既存の `currentProjectPath` 変数があり、本仕様の `ProjectLogger` も `currentProjectPath` を内部状態として持つため、SSOT原則違反となる。

**Judgment**: **Fix Required** ✅

**Evidence**:
handlers.tsの確認結果:
```typescript
// electron-sdd-manager/src/main/ipc/handlers.ts:79
let currentProjectPath: string | null = null;

// handlers.ts:321
export async function setProjectPath(projectPath: string): Promise<void> {
  logger.info('[handlers] setProjectPath called', { projectPath });
  currentProjectPath = projectPath;
  // ...
}
```

`currentProjectPath`は`handlers.ts`でプロジェクトパスの追跡に使用されており、同じ情報を`ProjectLogger`内でも管理するとSSoT違反になるという指摘は正しい。

**Action Items**:

1. `design.md`の「Architecture」セクションに状態管理の責務を明記する
   - `ProjectLogger`は`handlers.ts`の`setProjectPath`から呼び出される形で設計する
   - `ProjectLogger.setCurrentProject()`は`handlers.ts`の`setProjectPath()`内で呼び出される
   - `ProjectLogger`自身は`currentProjectPath`を内部状態として持つが、これは「ログ出力先の管理」という責務に限定
   - `handlers.ts`の`currentProjectPath`はアプリケーション全体のプロジェクト状態管理として維持

2. 設計の意図を明確化:
   - 両者は目的が異なる（アプリ状態管理 vs ログ出力先管理）
   - `handlers.ts`がマスター、`ProjectLogger`は通知を受ける形

---

## Response to Warnings

### W1: Preload script拡張がTasksに未記載

**Issue**: Preload scriptへの追加（`getProjectLogPath`, `openLogInBrowser` のRenderer公開）がTasksに明示されていない。

**Judgment**: **Fix Required** ✅

**Evidence**:
現在のpreload/index.ts（862行）を確認すると、新しいIPCチャンネルはpreloadに追加する必要がある。Tasks 3.1に「preload経由でレンダラープロセスに公開する」と記載はあるが、タスク説明が不十分。

**Action Items**:

- `tasks.md` Task 3.1に以下を追記:
  - 「`preload/index.ts`に`getProjectLogPath`、`openLogInBrowser` APIを追加する」
  - 「型定義（`ElectronAPI`）を更新する」

---

### W2: 並行書き込み安全性

**Issue**: 複数ウィンドウから同一プロジェクトへの書き込みが発生する場合の排他制御が未定義。

**Judgment**: **No Fix Needed** ❌

**Evidence**:
SDD Orchestratorのアーキテクチャを確認すると:
- 単一メインプロセスがログ書き込みを管理
- マルチウィンドウはレンダラープロセスであり、ログ書き込みはメインプロセス経由
- Node.jsのfs.WriteStreamは追記モード（`'a'`）で開かれ、OSレベルでアトミックな行書き込みが保証される（POSIX準拠OSでは4096バイト未満の書き込みはアトミック）
- 通常のログエントリサイズ（1行）は十分に小さい

設計ドキュメントの「Error Handling」セクションには既にストリームエラー時のフォールバック処理が定義されており、実用上問題ない。

---

### W3: 既存logger.ts呼び出し箇所の確認

**Issue**: 既存のlogger呼び出し箇所を洗い出し、互換性を確認するタスクを追加すべき。

**Judgment**: **Fix Required** ✅

**Evidence**:
設計では「既存のlogger.info/debug/warn/error APIを維持」と記載されているが、移行時の確認タスクが明示されていない。既存コードへの影響を事前に確認することは良い実践。

**Action Items**:

- `tasks.md` Task 4.1に以下を追記:
  - 「移行前に既存のlogger呼び出し箇所（handlers.ts, services/*.ts等）を洗い出す」
  - 「API互換性が維持されることを確認する」

---

## Response to Info (Low Priority)

| #   | Issue             | Judgment      | Reason                                                                                     |
| --- | ----------------- | ------------- | ------------------------------------------------------------------------------------------ |
| I1  | ファイルロック    | No Fix Needed | 設計のRisksセクションで「ローテーション失敗時はスキップ」と対応済み                         |
| I2  | 非同期ストリームエラー | No Fix Needed | Error Handlingセクションで「ストリームエラー時はグローバルログへフォールバック」と定義済み |

---

## Files to Modify

| File        | Changes                                                    |
| ----------- | ---------------------------------------------------------- |
| design.md   | C1: Architecture Integration セクションに状態管理の責務分担を追記 |
| tasks.md    | W1: Task 3.1にpreload追加の詳細を追記                       |
| tasks.md    | W3: Task 4.1に既存呼び出し箇所の確認を追記                  |

---

## Conclusion

3件の修正が必要と判定（C1, W1, W3）。2件は修正不要（W2, I1, I2）。

主な対応:
1. **C1**: SSOT違反の懸念に対し、`handlers.ts`と`ProjectLogger`の責務分担を設計に明記
2. **W1, W3**: タスクの詳細化（preload追加、既存呼び出し確認）

`--fix` フラグで修正を適用するか、手動で修正を行ってください。

---

_This reply was generated by the document-review-reply command._
