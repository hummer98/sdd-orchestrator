# 仕様検討記録

## 基本情報
- **作成日**: 2025-12-27
- **機能名**: cloudflare-tunnel-integration

## 初期要求
現在remoteWebServerは、ローカルネットワークからしか接続できないと思います。リモートWebサーバーを起動したときにcloudflare tunnelsに接続し、LAN外からアクセスできるようにしたいです

## 質疑応答

### Q1. 利用シナリオについて
**質問**:
- 1-1. Cloudflare Tunnelは主にどのような場面で使用しますか？
- 1-2. 同時に外部からアクセスするユーザー数はどの程度を想定していますか？

**回答**:
- 1-1: 外出先からアクセス
- 1-2: 1人

### Q2. Tunnel種別について
**質問**:
- 2-1. Quick Tunnel（無料）と Named Tunnel（Cloudflareアカウント連携）のどちらを希望しますか？

**回答**:
- 2-1: Named Tunnel

### Q3. 認証・セキュリティについて
**質問**:
- 3-1. 外部公開時の認証はどうしますか？（例: パスワード認証、Cloudflare Access、認証なし）
- 3-2. 現在のプライベートIP制限（LAN内のみ）は、Tunnel経由の場合はどう扱いますか？

**回答**:
- 3-1: トークン方式（QRコードにCloudflare TunnelsのURL+トークンを埋め込む。明示的にリフレッシュするまで同じトークン、永続化）
- 3-2: 両方でアクセス可能に

### Q4. UI/UXについて
**質問**:
- 4-1. Tunnelの開始・停止は既存のリモートサーバー開始ボタンと統合しますか？それとも別のトグルにしますか？
- 4-2. 生成されたTunnel URLの表示方法は？

**回答**:
- 4-1: 開始停止は統合したいが、cloudflare に公開するかどうかは開始時に選べるようにしたい（ついでにこの設定も永続化したい）
- 4-2: QRコード、コピーボタン両方

### Q5. Cloudflareアカウント連携について
**質問**:
- 6-1. トークンの設定方法はどちらが良いですか？（A: アプリの設定画面でトークンを入力・保存、B: 環境変数で設定）
- 6-2. トンネル作成の手順をアプリ内にガイドとして表示する機能は必要ですか？

**回答**:
- 6-1: 環境変数で設定 かつ アプリ設定画面を新規作成し、CLOUDFLARE_TUNNEL_TOKENを登録できるように。永続化方法は任せます。起動時に環境変数が設定されてれば優先。さもなくばアプリに設定されたトークンを利用
- 6-2: 不要（環境変数とアプリ設定両方対応するため）

### Q6. エラーハンドリングについて
**質問**:
- 7-1. cloudflaredバイナリがインストールされていない場合、自動インストールを試みますか？

**回答**:
- 7-1: Cloudflare Tunnelを選択した時に実行環境バリデーションをして、バイナリが無い場合はインストール方法を案内するダイアログ表示

### Q7. アクセストークンについて
**質問**:
- 8-1. 「QRコードにURL+トークン」の理解確認
- 8-2. トークンの長さ・形式に希望はありますか？

**回答**:
- 8-1: 理解で正しい（アプリがランダムなアクセストークンを生成・永続化、QRコードにURL+token埋め込み、WebSocket接続時に検証、リフレッシュボタンで新規生成）
- 8-2: 任せる。そんなに長くなくていい

### Q8. 設定画面について
**質問**:
- 9-1. 新規作成する「アプリ設定画面」に含める項目

**回答**:
- 9-1: Cloudflare Tunnel Tokenだけ。他は思いつかない

## 調査・検討結果
- **現在の実装**: `RemoteAccessServer`クラスでHTTP/WebSocketサーバーを管理、ポート8765-8775で動作、プライベートIPのみ許可
- **技術調査**: `cloudflared` npmパッケージでNode.jsから直接Tunnel制御可能
- **認証方式**: アプリ生成のアクセストークンをQRコードに埋め込み、WebSocket接続時に検証

## 決定事項
- Named Tunnelを使用（固定URL、制限なし）
- Cloudflare Tunnel Tokenは環境変数優先、なければアプリ設定から取得
- アクセストークンは短め、永続化、明示的リフレッシュまで同一
- サーバー開始時に「Cloudflareに公開」オプション選択可能、設定永続化
- cloudflaredバイナリがない場合はインストール案内ダイアログ表示（自動インストールはしない）
- LAN内・Tunnel経由どちらからもアクセス可能
- UIはQRコード+URLコピーボタン

## 備考
- ユーザーは事前にCloudflareでトンネルを作成しトークンを取得する必要がある
- cloudflaredバイナリの自動インストールは行わず、案内のみ
