# Implementation Plan

## Tasks

- [x] 1. WindowManagerサービスの基盤実装
- [x] 1.1 ウィンドウ状態管理の内部データ構造を実装する
  - ウィンドウIDとウィンドウ状態のマッピングを管理する機能
  - プロジェクトパスとウィンドウIDの双方向マッピング
  - ウィンドウごとのサービスインスタンス保持機能
  - _Requirements: 1.3, 3.3, 5.3_

- [x] 1.2 ウィンドウ作成・破棄のライフサイクル管理を実装する
  - 新規ウィンドウ作成時の初期化処理（プロジェクト選択画面表示）
  - ウィンドウタイトルへのプロジェクト名表示
  - ウィンドウクローズ時のリソース解放（Watcher停止、サービス破棄）
  - 最後のウィンドウ終了時の動作（macOSではメニューバー維持、他OSではアプリ終了）
  - _Requirements: 1.1, 1.3, 1.4, 1.5_

- [x] 1.3 (P) ウィンドウごとのサービスインスタンス生成を実装する
  - プロジェクト設定時にSpecManagerService、SpecsWatcherService等を生成
  - 各サービスのライフサイクルをウィンドウと連動
  - 複数ウィンドウでの同時エージェント実行の独立性確保
  - _Requirements: 5.3, 5.4_

- [x] 2. 重複オープン防止機能の実装
- [x] 2.1 プロジェクトパスの正規化と重複チェックを実装する
  - パスの正規化処理（相対パス解決、大文字小文字の統一）
  - 既存ウィンドウとの重複判定ロジック
  - 重複検出時のエラー情報生成
  - _Requirements: 3.3_

- [x] 2.2 重複検出時のウィンドウフォーカス動作を実装する
  - 既存ウィンドウへのフォーカス切替
  - 最小化されているウィンドウの復元処理
  - 重複オープン試行時の新規ウィンドウクローズ
  - _Requirements: 3.1, 3.2_

- [x] 2.3 (P) 外部からのプロジェクトオープン要求の重複チェックを実装する
  - コマンドライン引数からのプロジェクト指定時の重複チェック
  - ドラッグ＆ドロップによるプロジェクト指定時の重複チェック
  - 既存ウィンドウ存在時は新規オープンを抑止してフォーカス
  - _Requirements: 3.4_

- [x] 3. メニューコンテキスト切替の実装
- [x] 3.1 フォーカスウィンドウ変更の検出と通知を実装する
  - ウィンドウフォーカスイベントの監視
  - フォーカス変更時のコールバック実行
  - 現在のアクティブウィンドウの追跡
  - _Requirements: 2.1_

- [x] 3.2 メニュー状態のウィンドウ追従を実装する
  - フォーカスウィンドウのプロジェクトに応じたメニューコンテキスト更新
  - メニューバーへのアクティブプロジェクト名表示
  - プロジェクト未選択ウィンドウでのプロジェクト固有メニュー無効化
  - _Requirements: 2.3, 2.4_

- [x] 3.3 メニュー操作のウィンドウルーティングを実装する
  - Spec操作（作成・承認等）をフォーカス中のウィンドウに対して実行
  - 新規ウィンドウ作成メニュー項目の追加
  - ショートカットキーによる新規ウィンドウ作成
  - _Requirements: 1.1, 2.2_

- [x] 4. ウィンドウ状態の永続化と復元
- [x] 4.1 アプリ終了時のウィンドウ状態保存を実装する
  - 全ウィンドウの位置・サイズ・最大化・最小化状態の収集
  - 各ウィンドウで開いているプロジェクトパスの保存
  - ConfigStoreへのマルチウィンドウ状態配列の書き込み
  - _Requirements: 4.1, 4.5_

- [x] 4.2 アプリ起動時のウィンドウ復元を実装する
  - 保存されたウィンドウ状態の読み込み
  - 保存された位置・サイズでのウィンドウ再作成
  - 最大化・最小化状態の復元
  - 復元ウィンドウがない場合のデフォルトウィンドウ作成
  - _Requirements: 4.2, 4.4, 4.5_

- [x] 4.3 (P) プロジェクト不存在時のエラーハンドリングを実装する
  - 復元時のプロジェクトディレクトリ存在チェック
  - 存在しないプロジェクトのスキップ処理
  - ユーザーへの通知（どのプロジェクトがスキップされたか）
  - _Requirements: 4.3_

- [x] 4.4 (P) マルチディスプレイ環境での表示位置調整を実装する
  - 保存された表示位置のディスプレイ存在チェック
  - 存在しないディスプレイの場合はプライマリディスプレイに配置
  - ウィンドウがディスプレイ範囲外にならない調整
  - _Requirements: 4.6_

- [x] 5. IPCハンドラのマルチウィンドウ対応
- [x] 5.1 IPC呼び出し元ウィンドウの特定ロジックを実装する
  - WebContentsからのウィンドウID特定
  - ウィンドウIDからのサービスインスタンス取得
  - 無効なウィンドウからの呼び出しエラー処理
  - _Requirements: 5.3_

- [x] 5.2 既存IPCハンドラのマルチウィンドウ対応リファクタリング
  - グローバルサービスインスタンス参照をウィンドウ別インスタンスに置換
  - executePhase、getSpecs等の主要ハンドラの対応
  - ウィンドウクローズ時のイベントリスナー解除
  - _Requirements: 5.3, 5.4_

- [x] 5.3 (P) アプリケーション設定変更の全ウィンドウ通知を実装する
  - 設定変更時の全ウィンドウへのブロードキャスト
  - 各ウィンドウでの設定反映処理
  - _Requirements: 5.2_

- [x] 6. 既存コードのWindowManager統合
- [x] 6.1 main/index.tsのウィンドウ管理ロジックをWindowManagerに移行する
  - 既存のcreateWindow関数のWindowManager委譲
  - グローバルmainWindow変数の廃止
  - activateイベントのマルチウィンドウ対応
  - _Requirements: 1.1, 1.5_

- [x] 6.2 menu.tsのコンテキスト管理をWindowManagerと連携する
  - currentProjectPathForMenu変数の廃止
  - WindowManagerからのコンテキスト取得に変更
  - setMenuProjectPathのsetMenuContextへの置換
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 6.3 handlers.tsのサービス参照をウィンドウ別に変更する
  - グローバルspecManagerService、specsWatcherServiceの廃止
  - WindowManager経由でのサービスインスタンス取得
  - 既存テストのモック対象更新
  - _Requirements: 5.3, 5.4_

- [x] 7. 統合テストとE2Eテスト
- [x] 7.1 WindowManagerのユニットテストを作成する
  - ウィンドウ作成・破棄のテスト
  - 重複チェックロジックのテスト
  - 状態永続化・復元のテスト
  - _Requirements: 1.1, 1.4, 3.1, 3.2, 3.3, 4.1, 4.2, 4.3_

- [x] 7.2 マルチウィンドウ統合テストを作成する
  - 複数ウィンドウ作成と独立したプロジェクト操作
  - ウィンドウ間フォーカス切替とメニュー状態更新
  - 重複プロジェクトオープン試行と既存ウィンドウフォーカス
  - _Requirements: 1.2, 2.1, 3.1, 3.2_

- [x] 7.3 アプリ再起動復元のE2Eテストを作成する
  - アプリ終了から再起動後のウィンドウ復元確認
  - 位置・サイズ・プロジェクトの正確な復元
  - 複数ウィンドウでの同時エージェント実行テスト
  - _Requirements: 4.2, 4.5, 5.4_

- [x] 7.4 (P) ConfigStore拡張と一貫性のユニットテストを作成する
  - マルチウィンドウ状態の読み書きテスト
  - 全ウィンドウでの同一UI/スタイル使用確認
  - _Requirements: 4.1, 5.1_
