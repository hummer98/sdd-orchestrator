# Implementation Plan

## Task Overview

モバイルリモートアクセス機能の実装タスク。Electronメインプロセスにサーバーコンポーネントを追加し、スマートフォンブラウザからのリモートアクセスを可能にする。

---

- [x] 1. ユーティリティとヘルパーの実装
- [x] 1.1 (P) IPアドレス検証ユーティリティを実装する
  - プライベートIPアドレス範囲（10.x, 172.16-31.x, 192.168.x）を判定する関数を作成する
  - ループバックアドレス（127.x.x.x）とリンクローカル（169.254.x.x）を許可する
  - ローカルネットワークのIPv4アドレスを取得する機能を実装する
  - 単体テストでプライベートIP・パブリックIP・不正形式のケースをカバーする
  - _Requirements: 9.1_

- [x] 1.2 (P) レート制限ユーティリティを実装する
  - クライアントIPごとに100リクエスト/分の制限を設ける
  - 制限超過時に残り時間を返す機能を実装する
  - メモリベースのカウンタを使用し、時間経過でリセットする
  - 単体テストで制限内許可・制限超過・リセット動作を確認する
  - _Requirements: 9.3, 9.4_

- [x] 1.3 (P) ログバッファサービスを実装する
  - 直近100件のログエントリを保持するリングバッファを作成する
  - FIFO方式で古いエントリを破棄する
  - ログ追加・全取得・クリアの機能を提供する
  - 単体テストでエントリ追加・上限制限・FIFO動作を確認する
  - _Requirements: 4.2_

- [x] 2. サーバー基盤の実装
- [x] 2.1 RemoteAccessServerサービスを実装する
  - HTTP/WebSocketサーバーのライフサイクルを管理する
  - 起動時にポート利用可能性を事前チェックする
  - ポートが使用中の場合は次のポート（8765-8775範囲）を自動選択する
  - 全ポート使用中の場合は適切なエラーを返す
  - QRコード生成機能を組み込み接続URLをエンコードする
  - サーバー状態変更イベントを発行する
  - 停止時に全WebSocket接続を切断する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 2.1, 2.2, 2.3_

- [x] 2.2 静的ファイル配信機能を実装する
  - HTTPリクエストに対してモバイルUI用の静的ファイルを配信する
  - CORS設定を適用しローカルネットワークからのアクセスを許可する
  - Content-Typeを適切に設定する
  - _Requirements: 9.2_

- [x] 3. WebSocket通信ハンドラの実装
- [x] 3.1 WebSocketHandlerサービスの基本機能を実装する
  - WebSocket接続の受け入れとIP検証を行う
  - 接続数の追跡と最大接続数制限を設ける
  - クライアント識別子の管理を行う
  - 全接続切断機能を実装する
  - _Requirements: 8.5, 9.1_

- [x] 3.2 メッセージルーティングを実装する
  - 受信メッセージのJSONパースと型検証を行う
  - メッセージタイプに応じた処理の振り分けを実装する
  - レート制限チェックを適用する
  - 不正形式メッセージの無視とエラーレスポンスを返す
  - _Requirements: 9.3, 9.4_

- [x] 3.3 プロジェクト・Spec状態の配信を実装する
  - 接続時に現在のプロジェクト情報とSpec一覧を送信する
  - 接続時に直近のログ履歴を送信する
  - Spec状態変更時に全クライアントへブロードキャストする
  - _Requirements: 3.1, 3.2, 3.3, 4.2_

- [x] 3.4 ワークフロー操作コマンドを実装する
  - フェーズ実行コマンド（Requirements/Design/Tasks/Implementation）を処理する
  - ワークフロー停止・再開コマンドを処理する
  - SpecManagerServiceへの操作委譲を行う
  - 操作結果をクライアントに返す
  - 操作失敗時のエラーメッセージ送信を実装する
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.8_

- [x] 3.5 リアルタイムログ配信を実装する
  - エージェント出力をWebSocket経由で全クライアントに配信する
  - ログエントリをLogBufferに追加する
  - ログの種類（info/warning/error/agent）を区別して送信する
  - _Requirements: 4.1, 4.5_

- [x] 4. IPCハンドラとストアの実装
- [x] 4.1 (P) リモートアクセス用IPCハンドラを追加する
  - サーバー起動・停止用のIPCチャネルを追加する
  - サーバー状態取得用のIPCチャネルを追加する
  - 状態変更・クライアント数変更の通知チャネルを追加する
  - _Requirements: 1.1, 1.2, 1.6_

- [x] 4.2 (P) remoteAccessStoreを実装する
  - サーバー状態（起動中/停止中）を保持する
  - 接続URL・QRコード・ローカルIPを保持する
  - 接続中クライアント数を表示可能にする
  - エラーメッセージの保持とクリア機能を実装する
  - LocalStorageへの自動起動設定の永続化を実装する
  - _Requirements: 1.4, 1.5, 1.6, 8.5_

- [x] 5. ElectronアプリUIの実装
- [x] 5.1 リモートアクセスコントロールパネルを実装する
  - サーバー有効化チェックボックスを追加する
  - 接続URL表示エリアを追加する
  - QRコード表示エリアを追加する
  - 接続中クライアント数表示を追加する
  - サーバー起動状態インジケーターを追加する
  - _Requirements: 1.1, 1.2, 1.4, 1.5, 1.6, 2.2, 8.5_

- [x] 6. モバイルUIの実装
- [x] 6.1 モバイルUI基本構造を実装する
  - 静的HTMLとTailwind CDNによるスタイリングを設定する
  - レスポンシブデザインでスマートフォン画面に最適化する
  - タッチ操作に適したボタンサイズ（最小44x44px）を使用する
  - ダークモード・ライトモードの自動切り替えを実装する
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 6.2 WebSocket接続管理を実装する
  - サーバーへのWebSocket接続を確立する
  - 接続状態インジケーターを表示する
  - 切断時の自動再接続（指数バックオフ、最大5回）を実装する
  - 再接続中インジケーターを表示する
  - 全再接続失敗時の手動再接続ボタンを表示する
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [x] 6.3 Spec一覧・選択機能を実装する
  - プロジェクト内の全Specをリスト形式で表示する
  - 各Specのフェーズと承認状態をバッジで表示する
  - Spec選択時に詳細・操作パネルを表示する
  - Spec状態変更時のリアルタイム更新を実装する
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 6.4 ワークフロー操作パネルを実装する
  - フェーズ実行ボタン（Requirements/Design/Tasks/Implementation）を表示する
  - 停止・再開ボタンを表示する
  - 実行中インジケーターを表示する
  - 操作結果のトースト通知を表示する
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 7.6_

- [x] 6.5 リアルタイムログビューアを実装する
  - ログメッセージをリアルタイムで表示する
  - 自動スクロール機能を実装する
  - 手動スクロール時に自動スクロールを一時停止する
  - ログの種類を視覚的に区別する（色分け等）
  - _Requirements: 4.3, 4.4, 4.5_

- [x] 7. 統合とテスト
- [x] 7.1 サーバーとクライアントの結合テストを実施する
  - サーバー起動からクライアント接続、メッセージ送受信、切断までの一連のフローをテストする
  - ワークフローコマンド実行とログブロードキャストをテストする
  - ポート自動選択の動作をテストする
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 3.1, 3.2, 3.3, 5.1, 5.2, 5.3, 5.4_

- [x] 7.2 エンドツーエンドテストを実施する
  - モバイルUIからサーバーへの接続と操作をテストする
  - 再接続動作をテストする
  - 複数クライアント同時接続をテストする
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

---

## 追加タスク（統合不足の修正）

- [x] 8. サーバーとWebSocketHandlerの統合
- [x] 8.1 RemoteAccessServerにWebSocketHandlerを統合する
  - RemoteAccessServerのコンストラクタでWebSocketHandlerを初期化する
  - createServer時にWebSocketHandlerを初期化（initialize呼び出し）する
  - stop時にWebSocketHandler.disconnectAll()を呼び出す
  - getClientCount()をWebSocketHandlerのgetClientCount()に委譲する
  - handleWebSocketConnectionのTODOコメントを削除しWebSocketHandlerに委譲する
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 8.2 StateProviderをIPCハンドラに接続する
  - 現在のプロジェクトパスとSpec一覧を取得するStateProviderを実装する
  - SpecManagerServiceと連携してSpec情報を取得する
  - WebSocketHandlerにStateProviderを設定する
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 8.3 WorkflowControllerをIPCハンドラに接続する
  - ワークフロー操作をSpecManagerServiceに委譲するWorkflowControllerを実装する
  - WebSocketHandlerにWorkflowControllerを設定する
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [x] 8.4 メニューからのサーバー起動機能を実装する
  - ツールメニューに「リモートアクセスサーバーを起動/停止」項目を追加する
  - 起動時にQRコードとURLを表示するダイアログを表示する
  - サーバー状態に応じてメニューラベルを更新する
  - _Requirements: 1.1, 1.2, 1.4, 1.5, 2.2_
