# 状態管理と構造的課題の分析レポート

## 1. 概要
SDD Orchestratorにおいて、状態管理が分散し、場当たり的な修正や再発バグが発生しやすい状況にある原因を調査した。本レポートでは、プロジェクトのドキュメント、アーキテクチャガイドライン、および現在のコードベース構造を分析した結果をまとめる。

## 2. 調査結果

### 2.1. 構造の重複（「二重管理」問題）
コードベース内に、**ストア定義の重複**という明確な構造的リスクが確認された。

- **Renderer側のストア** (`electron-sdd-manager/src/renderer/stores/`):
  - `agentStore.ts`
  - `bugStore.ts`
  - `specStore.ts`
- **Shared側のストア** (`electron-sdd-manager/src/shared/stores/`):
  - `agentStore.ts`
  - `bugStore.ts`
  - `specStore.ts`

`structure.md` では、`shared` はElectronとRemote UIで共有されるコードのための場所とされているが、`renderer` に同名のストアが並存していることは、関心の分離が曖昧であることを示唆している。これにより以下の問題が発生する：
- **SSOT（信頼できる唯一の情報源）の欠如**: どちらのストアが最新の状態を持っているのかが不明確。
- **同期バグ**: 「エージェント一覧は更新したが、UIが別のストアを参照しているため反映されない」といった事象。
- **場当たり的な修正**: 同期問題を解決するために、ストア間で手動でデータをコピーするようなパッチが充てられる。

### 2.2. 文書間の矛盾（「最小限」 vs 「根本的」）

AIへの指示（プロンプト）において、微妙だが致命的な矛盾が存在する。

1.  **`design-principles.md`（理想）**:
    - 「場当たり的な解決」を厳禁。
    - 優先順位: **技術的正しさ** > 保守性。
    - 「AIは人間の実装コストを判断基準にしてはならない」と明記。

2.  **`bug-analyze.md`（運用）**:
    - 「**最小限の修正 (minimum viable fix)** を文書化し、オーバーエンジニアリングを避けること」と指示。

**影響**:
二重管理されたストア構造に起因するバグに遭遇した際、「最小限の修正」という指示が、アーキテクチャの修正（ストアの統合など）ではなく、局所的なパッチ（`useEffect` での同期追加など）を選択させてしまう。この「オーバーエンジニアリングの回避」という警告が、根本解決を阻害するバイアスとして働いている。

## 3. 根本原因の分析

「状態の分散」と「場当たり的な修正」は以下の結果である：
1.  **アーキテクチャの曖昧さ**: `structure.md` が、「ドメイン状態」と「UI状態」の境界を厳密に定義せず、ストアの重複を許容してしまっている。
2.  **プロンプトによる負のインセンティブ**: `bug-analyze` プロンプトが、意図せず「構造的修正」よりも「症状へのパッチ」を推奨する形になっている。

## 4. 推奨事項

### 4.1. 短期的なアクション（ドキュメント修正）

1.  **`bug-analyze.md` の更新**:
    - 「最小限の修正」を「**アーキテクチャとして正しい最小限の修正**」に置き換える。
    - 「その修正は状態の重複を導入していないか？」というチェック項目を追加。
    - `design-principles.md` の「場当たり的な修正の禁止」を明示的に参照させる。

2.  **`structure.md` の更新**:
    - ストアの配置境界を厳格に定義する。
    - **ルール**: ドメインデータ（Specs, Bugs, Agents）は **一箇所**（共有される場合は `shared/stores`）にのみ存在しなければならない。
    - **ルール**: `renderer/stores` は **UI専用の状態**（エディタのスクロール位置、モーダルの開閉など）に限定する。

### 4.2. 中長期的なアクション（リファクタリング）

1.  **ストアの統合**:
    - `renderer/stores` にある重複したストアを `shared/stores` に統合、あるいは役割を明確に分ける。
    - UI固有の派生データが必要な場合は、別個のストアを作るのではなく、共有ストア上の **Selector** を活用する。

2.  **状態フローの監査**:
    - IPC -> Store -> Component というデータフローが、単一かつ一方向であることを保証する。

## 5. 結論
本プロジェクトは、ガイドラインの矛盾によって「アーキテクチャのドリフト」が許容される状態にある。「バグ修正」の指示を「設計原則」に整合させ、ストアの階層構造を厳格化することで、「パッチを当てる開発」から「構造を安定させる開発」への転換が必要である。