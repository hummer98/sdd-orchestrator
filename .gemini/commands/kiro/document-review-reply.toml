description = "Generate neutral judgment and response to review issues (Refined)"

prompt = '''
# Document Review Reply

# !!! CRITICAL INSTRUCTION !!!
# The PRIMARY GOAL of this task is to CREATE A REPLY FILE.
# You MUST use the `write_file` tool to save the reply document.
# IF YOU DO NOT WRITE THE FILE, THE TASK IS FAILED.
# Do NOT update `spec.json` unless the reply file is successfully written.
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!

## Target Feature & Mode
Feature: `{{args}}`
(Check args for optional review number and flags: `--autofix`, `--fix`)

## 1. Preparation
1. **Identify Target**: Find the latest `document-review-{n}.md`.
2. **Read**: Read the review report and referenced spec files (`requirements.md`, `design.md`, `tasks.md`).
3. **Analyze Code**: Check actual source code before accepting review comments. (Reviewers can be wrong).

## 2. Judgment Process
For each issue in the review, decide:
- **Fix Required** ✅: Issue is valid, needs change.
- **No Fix Needed** ❌: Current state is correct (provide evidence).
- **Needs Discussion** ⚠️: Cannot decide.

*Principle: Code is Truth. If code works, prioritize it over spec.*

## 3. Execution Workflow (MANDATORY)

You must follow this exact sequence:

1.  **Generate Reply Content**:
    - Compile judgments into the report format below (WRITE IN JAPANESE).
    - Path: `.kiro/specs/{{args}}/document-review-{n}-reply.md`.

2.  **Save Reply File**:
    - **EXECUTE `write_file`** to save the reply.
    - *Wait for success confirmation.*

3.  **Apply Fixes (Conditional)**:
    - IF `--autofix` or `--fix` flag is present:
      - Apply changes to spec files (`requirements.md` etc).
      - Append "Applied Fixes" section to the reply file.

4.  **Update Status**:
    - ONLY AFTER the file is written, update `spec.json`.
    - `documentReview.roundDetails[n-1]`:
      - `status`: "reply_complete"
      - `fixStatus`: "applied" (if fixed), "pending" (if fixes needed but not applied), or "not_required".
    - **CRITICAL**: Do NOT set `approved` status if fixes were applied (needs re-review). Only approve if `fixStatus` is `not_required`.

## Report Structure Template

```markdown
# Response to Document Review #{n}

**Feature**: {feature-name}
**Review Date**: {original review date}
**Reply Date**: {YYYY-MM-DD}

## Response Summary
| Severity | Issues | Fix Required | No Fix Needed | Needs Discussion |
| -------- | ------ | ------------ | ------------- | ---------------- |
| Critical | X      | X            | X             | X                |
| Warning  | X      | X            | X             | X                |

## Response Details

### C{n}: {issue title}
**Judgment**: {**Fix Required** ✅ | **No Fix Needed** ❌ | **Needs Discussion** ⚠️}
**Reason/Evidence**: {理由またはコードの証拠}
**Action**: {修正内容}

(Repeat for all issues)

## Files to Modify
| File | Changes |
| ---- | ------- |
| ...  | ...     |

## Conclusion
{結論と次のステップ}
```

## Output
After completion, output the path of the reply file and the summary of judgments.
'''