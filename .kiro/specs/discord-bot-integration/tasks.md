# Implementation Plan

## Task Overview

Discord Bot統合機能の実装タスク。DiscordのSlash Command `/sdd` 経由でClaude Codeを操作し、応答をストリーミングで表示する機能を構築する。

---

## Tasks

- [ ] 1. Token暗号化とセキュリティ基盤の構築
- [ ] 1.1 (P) TokenEncryptionServiceの実装
  - Electron safeStorage APIを使用したToken暗号化・復号機能を実装する
  - 暗号化されたTokenをBase64エンコードで保存する形式にする
  - ログ出力用のTokenマスク機能を実装する（例: `Bot-XXXX...YYYY`）
  - safeStorage利用不可時のフォールバック処理を実装する
  - _Requirements: 10.1, 10.2_

- [ ] 1.2 (P) TokenEncryptionServiceのユニットテスト
  - encrypt/decrypt往復テストを実装する
  - マスク処理のテストを実装する
  - safeStorage利用不可時の動作テストを実装する
  - _Requirements: 10.1, 10.2_

- [ ] 2. 設定管理サービスの構築
- [ ] 2.1 DiscordConfigServiceの実装
  - Token優先順位ロジックを実装する（環境変数 > プロジェクト設定 > アプリ全体設定）
  - Token設定元を判別する機能を実装する
  - アプリ全体Token設定・取得機能を実装する
  - プロジェクトToken設定・取得機能を実装する
  - TokenEncryptionServiceと連携して暗号化・復号を行う
  - Token未設定時のバリデーションエラーを返す
  - 1.1に依存
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 2.2 チャンネル紐付け設定機能の実装
  - プロジェクト設定画面用のチャンネルID保存機能を実装する
  - 通知チャンネルID保存機能を実装する
  - `.kiro/settings/discord.json`への設定ファイル保存を実装する
  - チャンネルID重複検出機能を実装する
  - 重複時の警告メッセージ生成機能を実装する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 2.3 DiscordConfigServiceのユニットテスト
  - Token優先順位ロジックのテストを実装する
  - チャンネル重複検出のテストを実装する
  - 設定ファイル保存・読み込みのテストを実装する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 3. Discord Botコアサービスの構築
- [ ] 3.1 discord.jsパッケージの導入と初期設定
  - discord.js ^14.16をプロジェクト依存関係に追加する
  - 必要なGatewayIntents（Guilds, GuildMessages）を設定する
  - Slash Command `/sdd` の定義を作成する
  - _Requirements: 5.1_

- [ ] 3.2 DiscordBotServiceの実装
  - discord.js Clientのライフサイクル管理を実装する
  - Bot起動・停止機能を実装する
  - Botステータス（offline/connecting/online/reconnecting/error）管理を実装する
  - ステータス変更時のIPCイベント発行を実装する
  - Electronアプリ終了時の自動Bot終了を実装する
  - 3.1に依存
  - _Requirements: 3.2, 3.3, 3.4, 3.5, 3.6_

- [ ] 3.3 再接続ロジックの実装
  - Discord API接続切断時の自動再接続を実装する
  - 指数バックオフによる再接続試行（最大5回）を実装する
  - 再接続失敗時のBot停止とエラー通知を実装する
  - エラー内容のアプリログ記録を実装する
  - _Requirements: 9.1, 9.2, 9.3, 9.4_

- [ ] 3.4 DiscordBotServiceのユニットテスト
  - Bot起動・停止のテストを実装する
  - 再接続ロジックのテストを実装する
  - ステータス遷移のテストを実装する
  - _Requirements: 3.2, 3.3, 3.4, 3.5, 9.1, 9.2, 9.3_

- [ ] 4. メッセージング機能の構築
- [ ] 4.1 DiscordMessageServiceの実装
  - メッセージ送信・編集機能を実装する
  - 2000文字超過時の分割送信ロジックを実装する
  - コードブロックのMarkdown整形機能を実装する
  - ツール実行ログの折りたたみ（spoiler）フォーマット機能を実装する
  - 1000文字超過時の省略表示とファイル添付提案を実装する
  - _Requirements: 6.4, 6.5, 8.1, 8.2, 8.3, 8.4_

- [ ] 4.2 ストリーミング更新機能の実装
  - deferReply/editReplyを使用したストリーミングセッション管理を実装する
  - 1.5秒間隔のデバウンス更新を実装する
  - レート制限対応のキュー管理をdiscord.js組み込み機能で処理する
  - ストリーミング完了時の最終応答確定を実装する
  - _Requirements: 6.1, 6.2, 6.3_

- [ ] 4.3 Botステータス通知機能の実装
  - Bot起動時の通知メッセージ送信を実装する（Bot名、起動時刻、管理プロジェクト数）
  - Bot終了時の通知メッセージ送信を実装する（Bot名、終了時刻）
  - 通知チャンネルID未設定時のスキップ処理を実装する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 4.4 DiscordMessageServiceのユニットテスト
  - メッセージ分割ロジックのテストを実装する
  - 折りたたみフォーマットのテストを実装する
  - ストリーミング更新のテストを実装する
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 8.1, 8.2, 8.3_

- [ ] 5. Claude Code連携機能の構築
- [ ] 5.1 ClaudeCodeBridgeの実装
  - プロジェクト別Claude Codeセッション管理を実装する
  - 既存AgentProcess/AgentRegistryパターンを活用した連携を実装する
  - プロセス未起動時の自動起動機能を実装する
  - 応答ストリーミングのコールバック提供を実装する
  - AskQuestionイベントの検出と転送機能を実装する
  - _Requirements: 5.3, 5.5, 6.1, 6.2, 6.3, 7.3_

- [ ] 5.2 ClaudeCodeBridgeのエラーハンドリング
  - Claude Codeプロセスクラッシュ時のエラーメッセージ送信を実装する
  - セッション状態管理（running/waiting_input/completed/error）を実装する
  - _Requirements: 9.5_

- [ ] 5.3 ClaudeCodeBridgeのユニットテスト
  - セッション管理のテストを実装する
  - コールバック呼び出しのテストを実装する
  - エラーハンドリングのテストを実装する
  - _Requirements: 5.3, 5.5, 9.5_

- [ ] 6. インタラクション処理機能の構築
- [ ] 6.1 DiscordInteractionHandlerの実装
  - Interactionイベントのハンドラ登録を実装する
  - Slash Command `/sdd` の受信とチャンネル→プロジェクト解決を実装する
  - チャンネル未紐付け時のエラーメッセージ返信を実装する
  - 「処理中...」一時応答の送信を実装する
  - ClaudeCodeBridgeへの指示転送を実装する
  - 未登録チャンネルからのコマンド無視とログ記録を実装する
  - _Requirements: 5.2, 5.4, 5.6, 10.4_

- [ ] 6.2 AskQuestionボタンUI対応の実装
  - AskQuestion受信時のボタンUI生成を実装する
  - ButtonBuilderを使用した選択肢ボタン配置を実装する
  - ボタンクリック時の回答送信処理を実装する
  - 5分タイムアウトの設定とボタン無効化を実装する
  - タイムアウト時のメッセージ表示を実装する
  - _Requirements: 7.1, 7.2, 7.3, 7.5, 7.6_

- [ ] 6.3 AskQuestionモーダル対応の実装
  - テキスト入力要求時のモーダル表示用ボタンを実装する
  - ModalBuilder/TextInputBuilderを使用したモーダル構築を実装する
  - モーダル送信時の回答処理を実装する
  - _Requirements: 7.4_

- [ ] 6.4 DiscordInteractionHandlerのユニットテスト
  - プロジェクト解決ロジックのテストを実装する
  - ボタンインタラクションのテストを実装する
  - モーダルインタラクションのテストを実装する
  - _Requirements: 5.2, 5.4, 7.1, 7.2, 7.3, 7.4_

- [ ] 7. IPCチャンネルとハンドラの実装
- [ ] 7.1 (P) Discord関連IPCチャンネル定義
  - channels.tsにDiscord Bot管理用チャンネルを追加する
  - Bot起動/停止、ステータス取得のチャンネルを定義する
  - Token設定・取得のチャンネルを定義する
  - チャンネル設定のチャンネルを定義する
  - _Requirements: 1.1, 1.3, 2.3, 3.1, 3.2, 3.3_

- [ ] 7.2 Discord IPCハンドラの実装
  - Bot起動/停止ハンドラを実装する
  - ステータス取得ハンドラを実装する
  - Token設定・取得ハンドラを実装する
  - チャンネル設定ハンドラを実装する
  - チャンネル重複チェックハンドラを実装する
  - 7.1に依存
  - _Requirements: 1.1, 1.3, 2.3, 3.1, 3.2, 3.3_

- [ ] 7.3 preloadスクリプトへのAPI公開
  - electronAPIにDiscord関連メソッドを追加する
  - 型定義を更新する
  - 7.2に依存
  - _Requirements: 1.6, 2.1, 2.2, 3.1_

- [ ] 8. Renderer側状態管理の構築
- [ ] 8.1 (P) discordStoreの実装
  - Botステータス状態管理を実装する
  - Bot起動/停止アクションを実装する
  - エラー状態管理を実装する
  - ローディング状態（isStarting/isStopping）管理を実装する
  - _Requirements: 3.1, 3.4, 3.5, 3.7_

- [ ] 8.2 discordStoreとIPC連携
  - IPCステータス変更イベントの購読を実装する
  - Bot操作時のIPC呼び出しを実装する
  - 8.1と7.3に依存
  - _Requirements: 3.2, 3.3_

- [ ] 9. UIコンポーネントの構築
- [ ] 9.1 BotControlPanelの実装
  - Bot起動/停止トグルボタンを実装する
  - Token未設定時のボタン無効化を実装する
  - 既存のツールバーエリアへの配置を行う
  - 8.1に依存
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 9.2 BotStatusIndicatorの実装
  - オンライン/オフライン/接続中/エラーのステータスバッジを実装する
  - エラー時のツールチップでエラー詳細を表示する
  - 8.1に依存
  - _Requirements: 3.4, 3.5, 3.7_

- [ ] 9.3 DiscordChannelSettingsの実装
  - プロジェクト設定画面内にチャンネルID入力フィールドを配置する
  - 通知チャンネルID入力フィールドを配置する
  - チャンネルID重複時の警告バナー表示を実装する
  - 8.1に依存
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [ ] 9.4 BotTokenInput設定UIの実装
  - アプリ全体設定画面にパスワード形式（マスク表示）のToken入力フィールドを配置する
  - プロジェクト設定画面にオプションのToken上書きフィールドを配置する
  - 現在有効なToken源の表示を実装する
  - 8.1に依存
  - _Requirements: 1.1, 1.3, 1.6_

- [ ] 9.5 (P) UIコンポーネントのユニットテスト
  - BotControlPanelのレンダリングテストを実装する
  - BotStatusIndicatorの状態表示テストを実装する
  - DiscordChannelSettingsの入力・保存テストを実装する
  - _Requirements: 3.1, 3.4, 3.5, 2.1, 2.2_

- [ ] 10. 統合と結合テスト
- [ ] 10.1 Bot起動からSlash Command受信までの統合テスト
  - Bot起動→Slash Command受信→Claude Code転送→ストリーミング応答の一連フローをテストする
  - 再接続ロジックのシミュレーションテストを実装する
  - 6.1, 5.1, 4.2に依存
  - _Requirements: 3.2, 5.1, 5.2, 5.3, 6.1, 6.2, 6.3_

- [ ] 10.2 AskQuestion統合テスト
  - AskQuestion→ボタン表示→回答送信→セッション再開のフローをテストする
  - モーダル入力フローをテストする
  - 6.2, 6.3に依存
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [ ] 10.3 E2Eテスト
  - Bot起動/停止トグル操作のE2Eテストを実装する
  - チャンネル設定UI（入力、保存、重複警告）のE2Eテストを実装する
  - ステータスインジケーター表示変化のE2Eテストを実装する
  - 9.1, 9.2, 9.3に依存
  - _Requirements: 3.1, 3.4, 3.5, 2.1, 2.2, 2.4_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 2.1, 7.1, 7.2, 9.4 |
| 1.2 | 2.1 |
| 1.3 | 2.1, 7.1, 7.2, 9.4 |
| 1.4 | 2.1 |
| 1.5 | 2.1 |
| 1.6 | 7.3, 9.4 |
| 2.1 | 2.2, 7.3, 9.3 |
| 2.2 | 2.2, 7.3, 9.3 |
| 2.3 | 2.2, 7.1, 7.2, 9.3 |
| 2.4 | 2.2, 9.3 |
| 2.5 | 2.2 |
| 3.1 | 7.1, 7.2, 7.3, 9.1 |
| 3.2 | 3.2, 7.1, 7.2, 8.2, 9.1 |
| 3.3 | 3.2, 7.1, 7.2, 8.2, 9.1 |
| 3.4 | 3.2, 8.1, 9.2 |
| 3.5 | 3.2, 8.1, 9.2 |
| 3.6 | 3.2 |
| 3.7 | 8.1, 9.2 |
| 4.1 | 4.3 |
| 4.2 | 4.3 |
| 4.3 | 4.3 |
| 4.4 | 4.3 |
| 4.5 | 4.3 |
| 5.1 | 3.1 |
| 5.2 | 6.1 |
| 5.3 | 5.1 |
| 5.4 | 6.1 |
| 5.5 | 5.1 |
| 5.6 | 6.1 |
| 6.1 | 4.2, 5.1 |
| 6.2 | 4.2, 5.1 |
| 6.3 | 4.2, 5.1 |
| 6.4 | 4.1 |
| 6.5 | 4.1 |
| 7.1 | 6.2 |
| 7.2 | 6.2 |
| 7.3 | 5.1, 6.2 |
| 7.4 | 6.3 |
| 7.5 | 6.2 |
| 7.6 | 6.2 |
| 8.1 | 4.1 |
| 8.2 | 4.1 |
| 8.3 | 4.1 |
| 8.4 | 4.1 |
| 9.1 | 3.3 |
| 9.2 | 3.3 |
| 9.3 | 3.3 |
| 9.4 | 3.3 |
| 9.5 | 5.2 |
| 10.1 | 1.1 |
| 10.2 | 1.1 |
| 10.3 | - (discord.js HTTPS/WSS強制) |
| 10.4 | 6.1 |
